<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Маршруты для грузовиков</title>
  <style>
    :root {
      color-scheme: light;
      --accent: #1b6cff;
      --accent-dark: #0f4ec2;
      --danger: #ff3b30;
      --warning: #ff9500;
      --sheet-bg: rgba(255, 255, 255, 0.94);
      --panel-bg: rgba(255, 255, 255, 0.92);
      --shadow: 0 18px 44px rgba(15, 23, 42, 0.18);
      --font: "Inter", "Segoe UI", Roboto, sans-serif;
      --border: rgba(15, 23, 42, 0.08);
    }
    *,*::before,*::after{box-sizing:border-box;}
    html,body{height:100%;margin:0;font-family:var(--font);background:#f3f4f8;color:#0f172a;-webkit-font-smoothing:antialiased;}
    #map{position:fixed;inset:0;width:100%;height:100%;z-index:1;}
    .panel{position:fixed;z-index:1100;background:var(--panel-bg);box-shadow:var(--shadow);border-radius:18px;padding:16px 18px;backdrop-filter:blur(18px);transition:.3s;}
    .panel.hidden{opacity:0;pointer-events:none;}
    #recommendations{top:calc(16px + env(safe-area-inset-top));left:16px;width:min(360px,calc(100vw - 32px));display:flex;flex-direction:column;gap:12px;max-height:42vh;overflow-y:auto;}
    #legend{top:calc(16px + env(safe-area-inset-top));right:16px;display:flex;flex-direction:column;gap:10px;min-width:200px;font-size:14px;}
    .legend-item{display:grid;grid-template-columns:22px 1fr;align-items:center;gap:12px;}
    .legend-icon{width:16px;height:16px;border-radius:999px;}
    .legend-icon.red{background:var(--danger);}
    .legend-icon.orange{background:var(--warning);}
    .legend-line{width:24px;height:4px;border-radius:999px;background:var(--accent);}
    .sheet{position:fixed;left:0;right:0;bottom:0;z-index:1200;background:var(--sheet-bg);border-radius:26px 26px 0 0;box-shadow:0 -18px 48px rgba(15,23,42,0.35);padding:20px;display:flex;flex-direction:column;gap:18px;max-height:65dvh;transition:.35s;backdrop-filter:blur(20px);overflow:hidden;}
    form{display:grid;gap:14px;}
    .field{display:flex;flex-direction:column;gap:6px;}
    .field input{padding:12px 14px;border-radius:14px;border:1px solid var(--border);font-size:15px;background:rgba(255,255,255,.95);max-height:44px;}
    .toggles{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px;font-size:14px;}
    .toggles label{display:flex;align-items:center;gap:8px;padding:10px 12px;border-radius:12px;background:rgba(15,23,42,.06);}
    .actions{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;}
    .actions button{padding:14px;border-radius:16px;border:none;font-size:15px;font-weight:600;cursor:pointer;color:#fff;background:var(--accent);box-shadow:0 12px 30px rgba(27,108,255,.25);}
    .actions button.secondary{background:#1f2937;}
    .actions button.danger{background:var(--danger);}
    .steps{border-radius:16px;background:rgba(15,23,42,.06);padding:12px 16px 16px;max-height:180px;overflow-y:auto;}
    .steps[hidden]{display:none;}
    .steps h3{margin:0 0 10px;font-size:15px;font-weight:700;}
    .steps ol{margin:0;padding-left:18px;display:flex;flex-direction:column;gap:8px;font-size:14px;}
    .steps li.active{color:var(--accent-dark);font-weight:600;}
    .panel-toggle{position:fixed;top:calc(env(safe-area-inset-top) + 16px);right:16px;z-index:1500;padding:10px 14px;border-radius:999px;background:rgba(15,23,42,.85);color:#fff;font-size:13px;font-weight:600;}
    #recommendationsToggleBtn{right:auto;left:16px;}
  </style>
  <script src="https://api-maps.yandex.ru/2.1/?apikey=292c3277-6b44-4b1d-88db-813ff4caa159&lang=ru_RU"></script>
</head>
<body>
  <div id="map"></div>

  <section id="recommendations" class="panel">
    <h2>Рекомендации</h2>
    <ul id="recommendationsList"><li>Постройте маршрут, чтобы получить рекомендации.</li></ul>
  </section>

  <aside id="legend" class="panel">
    <h2>Легенда</h2>
    <div class="legend-item"><span class="legend-icon red"></span>Весовые рамки</div>
    <div class="legend-item"><span class="legend-icon orange"></span>Платон</div>
    <div class="legend-item"><span class="legend-line"></span>Основной маршрут</div>
  </aside>

  <div class="sheet" id="bottomSheet">
    <form id="routeForm">
      <div class="field"><label for="fromInput">Откуда</label><input id="fromInput" type="text" placeholder="Адрес или широта,долгота"></div>
      <div class="field"><label for="toInput">Куда</label><input id="toInput" type="text" placeholder="Адрес или широта,долгота"></div>
      <div class="toggles">
        <label><input type="checkbox" id="weightToggle" checked> Весовые рамки</label>
        <label><input type="checkbox" id="platonToggle"> Платон</label>
        <label><input type="checkbox" id="tollToggle"> Избегать платных дорог</label>
      </div>
      <div class="actions">
        <button type="submit" id="buildRouteBtn">Построить маршрут</button>
        <button type="button" class="secondary" id="detourBtn">ИИ-объезд</button>
        <button type="button" class="secondary" id="resetDetourBtn">Сбросить выбор зон</button>
        <button type="button" class="danger" id="clearBtn">Очистить</button>
        <button type="button" class="secondary" id="gpxBtn">GPX экспорт</button>
        <button type="button" class="secondary" id="shareBtn">Поделиться</button>
        <button type="button" class="secondary" id="locateBtn">Моя позиция</button>
      </div>
    </form>
    <div class="steps" id="stepsBlock" hidden><h3>Пошаговая навигация</h3><ol id="stepsList"></ol></div>
  </div>

<script>
(() => {
  const state = {
    map:null,routeLine:null,routeMarkers:[],routeData:null,routeHistory:[],
    weightZones:[],platonZones:[],detourList:[]
  };
  const elements={
    fromInput:document.getElementById('fromInput'),
    toInput:document.getElementById('toInput'),
    weightToggle:document.getElementById('weightToggle'),
    platonToggle:document.getElementById('platonToggle'),
    tollToggle:document.getElementById('tollToggle'),
    detourBtn:document.getElementById('detourBtn'),
    resetDetourBtn:document.getElementById('resetDetourBtn'),
    clearBtn:document.getElementById('clearBtn'),
    gpxBtn:document.getElementById('gpxBtn'),
    shareBtn:document.getElementById('shareBtn'),
    locateBtn:document.getElementById('locateBtn'),
    stepsBlock:document.getElementById('stepsBlock'),
    stepsList:document.getElementById('stepsList'),
    recommendationsList:document.getElementById('recommendationsList')
  };
  let tollWarned=false;

  ymaps.ready(init);
  function init(){
    state.map=new ymaps.Map("map",{center:[55.75,37.57],zoom:6,controls:['zoomControl']});
    bindEvents();
  }

  function bindEvents(){
    elements.detourBtn.onclick=handleDetour;
    elements.resetDetourBtn.onclick=resetDetourSelection;
    elements.clearBtn.onclick=clearRoute;
    elements.tollToggle.onchange=()=>{
      if(elements.tollToggle.checked && !tollWarned){
        alert("На публичном OSRM «избегать платных дорог» может игнорироваться. В Google Maps работает.");
        tollWarned=true;
      }
    };
  }

  function resetDetourSelection(){
    [...state.weightZones,...state.platonZones].forEach(z=>{
      z.__selected=false;
      if(z.circle){z.circle.options.set('strokeWidth',2);z.circle.options.set('strokeOpacity',0.6);}
    });
    state.detourList=[];
  }

  async function handleDetour(){
    if(!state.routeData){alert("Сначала постройте маршрут.");return;}
    const hits=state.detourList.length?state.detourList.map(z=>({zone:z,point:z.center})):state.routeData.intersections||[];
    if(!hits.length){alert("Нет зон для объезда.");return;}
    alert("ИИ-объезд (демо): выбрано зон: "+hits.length);
  }

  function clearRoute(){
    if(state.routeLine){state.map.geoObjects.remove(state.routeLine);state.routeLine=null;}
    state.routeMarkers.forEach(m=>state.map.geoObjects.remove(m));
    state.routeMarkers=[];state.routeData=null;state.detourList=[];
    elements.stepsList.innerHTML='';elements.stepsBlock.hidden=true;
    elements.recommendationsList.innerHTML='<li>Маршрут очищен.</li>';
  }

})();
</script>
</body>
</html>
